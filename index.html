<html>
  <body>
    <script>
      function parseUrl(inputUrl) {
        const url = new URL(inputUrl);
        const host = url.searchParams.get('host');
        const baseUrl = `http://${host}`;
        const zpl = url.searchParams.get('zpl');
        return { host, baseUrl, zpl };
      }
      let extensionDetected;

      window.addEventListener('message', function (event) {
        if (!event.data.ZebraPrintingVersion) {
          return;
        }

        const { zpl, host, baseUrl } = parseUrl(document.location.href);

        extensionDetected = true;
        if (!host && !zpl) {
          document.getElementById('root').innerHTML = `
          
            <div>URL too long? Enter it here:</div>
            <textarea id="url-input" style="width: 100%; height: 100px;"></textarea>
            <button type="button" id="print-input-button">Print</button>
            
          
          `;
          document
            .getElementById('print-input-button')
            .addEventListener('click', () => {
              print();
            });
          return;
        } else if (!host || !zpl) {
          document.getElementById('root').innerHTML = `
        <h1>Missing search parameters</h1>
        You must provide the <pre style="display: inline-block">host</pre> and <pre style="display: inline-block;">zpl</pre> parameters.
        `;
          return;
        }

        function print() {
          let finalZpl = zpl;
          let finalBaseUrl = baseUrl;
          if (!finalZpl) {
            const { zpl, baseUrl } = parseUrl(
              document.getElementById('url-input').value,
            );
            finalZpl = zpl;
            finalBaseUrl = baseUrl;
          }

          if (!finalZpl || !finalBaseUrl) {
            return;
          }
          window.postMessage(
            {
              type: 'zebra_print_label',
              zpl: finalZpl,
              url: `${finalBaseUrl}/pstprnt`,
            },
            '*',
          );
        }

        print();
        document.getElementById('root').innerHTML = `
        <h1>Print job sent</h1>
        <button id="reprint-button">${zpl ? 'Reprint' : 'Print'}</button>
        <p>Host: <a href="${baseUrl}" target="_blank">${host}</a></p>
        <code>
          <pre>${zpl}</pre>
        </code>
        `;

        document
          .getElementById('reprint-button')
          .addEventListener('click', () => {
            print();
          });
      });
      setTimeout(() => {
        if (!extensionDetected) {
          // Show extension not detected with link
          // https://chrome.google.com/webstore/detail/zebra-printing/ndikjdigobmbieacjcgomahigeiobhbo?hl=en

          console.log('not detected');
          document.getElementById('root').innerHTML = `
            <div>
              <h1>Zebra Print Extension not detected</h1>
              <p>
                Please install the Zebra Print Extension from the Chrome Webstore.
              </p>
              <a href="https://chrome.google.com/webstore/detail/zebra-printing/ndikjdigobmbieacjcgomahigeiobhbo?hl=en">
                Install Zebra Print Extension
              </a>
            </div>
          `;
        }
      }, 3000);
    </script>
    <div id="root">
      <h1>Loading...</h1>
    </div>
  </body>
</html>
